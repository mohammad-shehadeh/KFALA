<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأصناف - البحث بالباركود</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .search-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .search-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--primary-color);
            font-weight: 700;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: var(--warning-color);
        }

        .btn-danger:hover {
            background-color: #d1145a;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .scanner-container {
            display: none;
            position: relative;
            margin: 20px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        #interactive {
            position: relative;
            width: 100%;
            height: 300px;
        }

        #interactive video {
            width: 100%;
            height: auto;
            display: block;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .scanner-frame {
            width: 80%;
            max-width: 400px;
            height: 150px;
            border: 3px solid var(--accent-color);
            border-radius: 8px;
            position: relative;
        }

        .scanner-frame::before, .scanner-frame::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: var(--accent-color);
            border-style: solid;
            border-width: 0;
        }

        .scanner-frame::before {
            top: 0;
            left: 0;
            border-top-width: 3px;
            border-left-width: 3px;
            border-top-left-radius: 5px;
        }

        .scanner-frame::after {
            top: 0;
            right: 0;
            border-top-width: 3px;
            border-right-width: 3px;
            border-top-right-radius: 5px;
        }

        .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .scanner-zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--dark-color);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            border: none;
        }

        .control-btn:hover {
            background-color: white;
            transform: scale(1.1);
        }

        .control-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
        }

        .success {
            background-color: rgba(76, 201, 240, 0.2);
            color: #0d6efd;
        }

        .error {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--warning-color);
        }

        .info {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ff9800;
        }

        .result-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: popupFadeIn 0.3s ease;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .popup-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        .close-popup {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }

        .close-popup:hover {
            color: var(--warning-color);
        }

        .product-info {
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-label {
            font-weight: 500;
            color: #555;
        }

        .info-value {
            font-weight: 600;
            color: var(--dark-color);
        }

        .product-price .info-value {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .not-found {
            text-align: center;
            padding: 20px;
            color: var(--warning-color);
            font-weight: 500;
        }

        .history-section {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .history-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #f8f9fa;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .history-item-details {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .history-item-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .action-btn:hover {
            color: var(--primary-color);
        }

        .action-btn.delete:hover {
            color: var(--warning-color);
        }

        .processing-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
        }

        .processing-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .mode-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 25;
        }

        .quality-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 25;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-enhanced {
            background-color: rgba(72, 149, 239, 0.8);
        }

        .image-preview {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            padding: 20px;
        }

        .image-preview-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-preview-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .image-comparison {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .image-container {
            flex: 1;
            text-align: center;
        }

        .image-container img {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid #eee;
        }

        .image-label {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .camera-settings {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: var(--border-radius);
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 25;
            max-width: 250px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: center;
        }

        .setting-label {
            font-size: 0.8rem;
        }

        .setting-value {
            font-weight: bold;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .scanner-frame {
                width: 90%;
                height: 120px;
            }
            
            .popup-content {
                width: 95%;
                padding: 15px;
            }
            
            .info-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .image-comparison {
                flex-direction: column;
            }
            
            .camera-settings {
                max-width: 200px;
                top: 40px;
            }
        }

        /* Animation for barcode scan */
        @keyframes scanAnimation {
            0% {
                top: 0;
            }
            100% {
                top: calc(100% - 4px);
            }
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(72, 149, 239, 0.8);
            box-shadow: 0 0 10px rgba(72, 149, 239, 0.8);
            animation: scanAnimation 2s infinite linear;
            z-index: 15;
        }

        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            
            .search-section, .history-section, .popup-content {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }
            
            input[type="text"], input[type="number"] {
                background-color: #2d2d2d;
                color: #e0e0e0;
                border-color: #444;
            }
            
            .info-label, .tab-btn:not(.active), .action-btn {
                color: #aaa;
            }
            
            .info-value {
                color: #e0e0e0;
            }
            
            .history-item:hover {
                background-color: #2a2a2a;
            }
            
            .popup-header, .history-title {
                border-bottom-color: #444;
            }
            
            .info-row, .history-item {
                border-bottom-color: #444;
            }
            
            .image-preview {
                background-color: #1e1e1e;
                color: #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-barcode"></i> نظام إدارة الأصناف</h1>
            <p>ابحث عن الأصناف باستخدام الباركود أو اسم المنتج</p>
        </header>

        <section class="search-section">
            <div class="search-tabs">
                <button class="tab-btn active" data-tab="barcode-tab"><i class="fas fa-barcode"></i> البحث بالباركود</button>
                <button class="tab-btn" data-tab="name-tab"><i class="fas fa-search"></i> البحث بالاسم</button>
            </div>

            <div id="barcode-tab" class="tab-content active">
                <form id="barcode-form">
                    <div class="form-group">
                        <label for="barcode-input"><i class="fas fa-qrcode"></i> أدخل الباركود:</label>
                        <input type="text" id="barcode-input" placeholder="مسح الباركود أو إدخاله يدويًا" autocomplete="off">
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" id="start-scanner" class="btn"><i class="fas fa-camera"></i> بدء الماسح الضوئي</button>
                        <button type="submit" class="btn btn-secondary"><i class="fas fa-search"></i> بحث</button>
                        <button type="button" id="ai-enhance-btn" class="btn" style="background-color: #ff9800;"><i class="fas fa-magic"></i> تحسين الذكاء الاصطناعي</button>
                    </div>
                </form>

                <div id="scanner-container" class="scanner-container">
                    <div id="interactive" class="viewport">
                        <div id="processing-overlay" class="processing-overlay">
                            <div class="processing-spinner"></div>
                            <p id="processing-message">جاري معالجة الصورة...</p>
                        </div>
                        <video playsinline></video>
                        <div class="scan-line"></div>
                        <div class="scanner-overlay">
                            <div class="scanner-frame"></div>
                        </div>
                        <div id="mode-indicator" class="mode-indicator">وضع القراءة: باركود</div>
                        <div id="quality-indicator" class="quality-indicator">
                            <i class="fas fa-image"></i>
                            <span>جودة: متوسطة</span>
                        </div>
                        <div id="camera-settings" class="camera-settings">
                            <div class="setting-item">
                                <span class="setting-label">الوضوح:</span>
                                <span class="setting-value" id="sharpness-value">0</span>
                            </div>
                            <div class="setting-item">
                                <span class="setting-label">التباين:</span>
                                <span class="setting-value" id="contrast-value">0</span>
                            </div>
                            <div class="setting-item">
                                <span class="setting-label">السطوع:</span>
                                <span class="setting-value" id="brightness-value">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="scanner-controls">
                        <button id="toggle-ai" class="control-btn active" title="تفعيل الذكاء الاصطناعي"><i class="fas fa-robot"></i></button>
                        <button id="capture-frame" class="control-btn" title="التقاط صورة"><i class="fas fa-camera-retro"></i></button>
                        <button id="toggle-settings" class="control-btn" title="إعدادات الكاميرا"><i class="fas fa-cog"></i></button>
                        <button id="switch-camera" class="control-btn" title="تبديل الكاميرا"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    <div class="scanner-zoom-controls">
                        <button id="zoom-out-barcode" class="control-btn" title="تصغير"><i class="fas fa-search-minus"></i></button>
                        <button id="zoom-reset-barcode" class="control-btn" title="إعادة الضبط"><i class="fas fa-expand-arrows-alt"></i></button>
                        <button id="zoom-in-barcode" class="control-btn" title="تكبير"><i class="fas fa-search-plus"></i></button>
                    </div>
                </div>

                <div id="status-message" class="status-message"></div>
            </div>

            <div id="name-tab" class="tab-content">
                <form id="name-search-form">
                    <div class="form-group">
                        <label for="name-input"><i class="fas fa-tag"></i> أدخل اسم المنتج:</label>
                        <input type="text" id="name-input" placeholder="اسم المنتج أو جزء منه" autocomplete="off">
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn"><i class="fas fa-search"></i> بحث</button>
                    </div>
                </form>

                <div id="name-search-results" class="search-results" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section class="history-section">
            <h2 class="history-title"><i class="fas fa-history"></i> سجل البحث</h2>
            <ul class="history-list" id="search-history">
                <!-- سيتم ملؤه بالنتائج السابقة -->
            </ul>
        </section>
    </div>

    <div id="result-popup" class="result-popup">
        <div class="popup-content">
            <div class="popup-header">
                <h2 class="popup-title"><i class="fas fa-info-circle"></i> تفاصيل المنتج</h2>
                <button class="close-popup" id="close-popup">&times;</button>
            </div>
            
            <div class="product-info" id="product-info">
                <!-- سيتم ملؤه بالنتائج -->
            </div>
            
            <div class="btn-group">
                <button class="btn" id="print-result"><i class="fas fa-print"></i> طباعة</button>
                <button class="btn btn-secondary" id="close-result">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="image-preview" class="image-preview">
        <div class="image-preview-content">
            <div class="image-preview-title">مقارنة معالجة الصورة</div>
            <div class="image-comparison">
                <div class="image-container">
                    <img id="original-image" src="" alt="الصورة الأصلية">
                    <div class="image-label">الصورة الأصلية</div>
                </div>
                <div class="image-container">
                    <img id="enhanced-image" src="" alt="الصورة المحسنة">
                    <div class="image-label">الصورة المحسنة</div>
                </div>
            </div>
            <div class="btn-group">
                <button id="close-preview" class="btn btn-secondary">إغلاق</button>
                <button id="use-enhanced" class="btn">استخدام الصورة المحسنة</button>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/deeplab@0.2.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // عناصر واجهة المستخدم
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const barcodeInput = document.getElementById('barcode-input');
            const nameInput = document.getElementById('name-input');
            const popup = document.getElementById('result-popup');
            const startScannerButton = document.getElementById('start-scanner');
            const statusMessage = document.getElementById('status-message');
            const scannerContainer = document.getElementById('scanner-container');
            const barcodeForm = document.getElementById('barcode-form');
            const nameSearchForm = document.getElementById('name-search-form');
            const searchHistory = document.getElementById('search-history');
            const productInfo = document.getElementById('product-info');
            const closePopupBtn = document.getElementById('close-popup');
            const closeResultBtn = document.getElementById('close-result');
            const printResultBtn = document.getElementById('print-result');
            const zoomInBtn = document.getElementById('zoom-in-barcode');
            const zoomOutBtn = document.getElementById('zoom-out-barcode');
            const zoomResetBtn = document.getElementById('zoom-reset-barcode');
            const toggleAIBtn = document.getElementById('toggle-ai');
            const captureFrameBtn = document.getElementById('capture-frame');
            const toggleSettingsBtn = document.getElementById('toggle-settings');
            const switchCameraBtn = document.getElementById('switch-camera');
            const processingOverlay = document.getElementById('processing-overlay');
            const processingMessage = document.getElementById('processing-message');
            const modeIndicator = document.getElementById('mode-indicator');
            const qualityIndicator = document.getElementById('quality-indicator');
            const aiEnhanceBtn = document.getElementById('ai-enhance-btn');
            const imagePreview = document.getElementById('image-preview');
            const originalImage = document.getElementById('original-image');
            const enhancedImage = document.getElementById('enhanced-image');
            const closePreviewBtn = document.getElementById('close-preview');
            const useEnhancedBtn = document.getElementById('use-enhanced');
            
            // متغيرات النظام
            let lastReadValues = [];
            let isProcessing = false;
            let scannerActive = false;
            let videoTrack = null;
            let currentZoom = 1;
            let minZoom = 1;
            let maxZoom = 5;
            let zoomStep = 0.5;
            let searchHistoryData = JSON.parse(localStorage.getItem('searchHistory')) || [];
            let barcodeAttempts = 0;
            const maxBarcodeAttempts = 3;
            let currentMode = 'barcode';
            let ocrWorker = null;
            let isAIEnabled = true;
            let currentCamera = 'environment';
            let cameraSettingsVisible = false;
            let deeplabModel = null;
            let tfReady = false;
            let imageQualityScore = 0;
            let lastProcessedImage = null;
            let currentStream = null;
            
            // تهيئة TensorFlow.js
            async function initializeTensorFlow() {
                try {
                    // تحميل نموذج DeepLabV3+ لتحديد وتحسين الأشكال
                    processingMessage.textContent = 'جاري تحميل الذكاء الاصطناعي...';
                    processingOverlay.style.display = 'flex';
                    
                    await tf.ready();
                    tfReady = true;
                    
                    console.log('TensorFlow.js جاهز للإستخدام');
                    
                    processingOverlay.style.display = 'none';
                    
                    // تحميل نموذج معالجة الصور
                    loadImageEnhancementModel();
                    
                } catch (error) {
                    console.error('خطأ في تهيئة TensorFlow:', error);
                    processingOverlay.style.display = 'none';
                    showStatusMessage('تعذر تحميل الذكاء الاصطناعي، سيتم استخدام المعالجة التقليدية', 'info');
                }
            }
            
            // تحميل نموذج تحسين الصور
            async function loadImageEnhancementModel() {
                try {
                    // استخدام نماذج TensorFlow.js المدمجة لمعالجة الصور
                    console.log('نماذج معالجة الصور جاهزة');
                    showStatusMessage('الذكاء الاصطناعي جاهز لتحسين الصور', 'success');
                } catch (error) {
                    console.error('خطأ في تحميل النموذج:', error);
                }
            }
            
            // تحليل جودة الصورة
            function analyzeImageQuality(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                let brightness = 0;
                let contrast = 0;
                let edgeScore = 0;
                
                // حساب السطوع
                for (let i = 0; i < data.length; i += 4) {
                    brightness += (data[i] + data[i+1] + data[i+2]) / 3;
                }
                brightness = brightness / (data.length / 4) / 255;
                
                // حساب التباين
                const mean = brightness * 255;
                let variance = 0;
                for (let i = 0; i < data.length; i += 4) {
                    const pixelValue = (data[i] + data[i+1] + data[i+2]) / 3;
                    variance += Math.pow(pixelValue - mean, 2);
                }
                contrast = Math.sqrt(variance / (data.length / 4)) / 255;
                
                // حساب حدة الحواف (بسيط)
                edgeScore = detectEdgesSimple(canvas);
                
                // حساب النتيجة النهائية
                imageQualityScore = (brightness * 0.3 + contrast * 0.4 + edgeScore * 0.3) * 100;
                
                // تحديث المؤشر
                updateQualityIndicator();
                
                return {
                    brightness: brightness * 100,
                    contrast: contrast * 100,
                    edgeScore: edgeScore * 100,
                    overall: imageQualityScore
                };
            }
            
            // كشف الحواف البسيط
            function detectEdgesSimple(canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;
                
                let edgeSum = 0;
                const kernel = [
                    [-1, -1, -1],
                    [-1,  8, -1],
                    [-1, -1, -1]
                ];
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const pixelIndex = ((y + ky) * width + (x + kx)) * 4;
                                const pixelValue = (data[pixelIndex] + data[pixelIndex + 1] + data[pixelIndex + 2]) / 3;
                                sum += pixelValue * kernel[ky + 1][kx + 1];
                            }
                        }
                        edgeSum += Math.abs(sum);
                    }
                }
                
                const maxPossibleEdges = (width - 2) * (height - 2) * 255 * 8;
                return edgeSum / maxPossibleEdges;
            }
            
            // تحديث مؤشر الجودة
            function updateQualityIndicator() {
                if (!qualityIndicator) return;
                
                let qualityText = "ضعيفة";
                let iconClass = "fas fa-times-circle";
                let colorClass = "";
                
                if (imageQualityScore > 70) {
                    qualityText = "ممتازة";
                    iconClass = "fas fa-check-circle";
                } else if (imageQualityScore > 50) {
                    qualityText = "جيدة";
                    iconClass = "fas fa-check-circle";
                } else if (imageQualityScore > 30) {
                    qualityText = "متوسطة";
                    iconClass = "fas fa-exclamation-circle";
                } else {
                    qualityText = "ضعيفة";
                    iconClass = "fas fa-times-circle";
                }
                
                qualityIndicator.innerHTML = `<i class="${iconClass}"></i><span>جودة: ${qualityText}</span>`;
            }
            
            // تحسين الصورة باستخدام الذكاء الاصطناعي
            async function enhanceImageWithAI(imageData) {
                if (!tfReady || !isAIEnabled) {
                    return enhanceImageTraditional(imageData);
                }
                
                try {
                    processingMessage.textContent = 'جاري تحسين الصورة بالذكاء الاصطناعي...';
                    processingOverlay.style.display = 'flex';
                    
                    // تحويل ImageData إلى tensor
                    const tensor = tf.browser.fromPixels({
                        data: new Uint8Array(imageData.data),
                        width: imageData.width,
                        height: imageData.height
                    }, 4);
                    
                    // تطبيق تحسينات متعددة
                    let enhancedTensor = tensor;
                    
                    // 1. ضبط السطوع والتباين
                    enhancedTensor = tf.image.adjustBrightness(enhancedTensor, 0.1);
                    enhancedTensor = tf.image.adjustContrast(enhancedTensor, 1.5);
                    
                    // 2. تحسين الحدة باستخدام convolution
                    enhancedTensor = enhanceSharpness(enhancedTensor);
                    
                    // 3. تقليل الضوضاء
                    enhancedTensor = reduceNoise(enhancedTensor);
                    
                    // 4. تحويل إلى تدرج الرمادي للباركود
                    const grayTensor = tf.image.rgbToGrayscale(enhancedTensor);
                    
                    // 5. زيادة التباين أكثر للباركود
                    const finalTensor = enhanceBarcodeContrast(grayTensor);
                    
                    // تحويل tensor إلى ImageData
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = imageData.width;
                    finalCanvas.height = imageData.height;
                    
                    await tf.browser.toPixels(finalTensor, finalCanvas);
                    
                    const finalImageData = finalCanvas.getContext('2d').getImageData(0, 0, finalCanvas.width, finalCanvas.height);
                    
                    // تنظيف الذاكرة
                    tensor.dispose();
                    enhancedTensor.dispose();
                    grayTensor.dispose();
                    finalTensor.dispose();
                    
                    processingOverlay.style.display = 'none';
                    
                    return finalImageData;
                    
                } catch (error) {
                    console.error('خطأ في تحسين الصورة بالذكاء الاصطناعي:', error);
                    processingOverlay.style.display = 'none';
                    return enhanceImageTraditional(imageData);
                }
            }
            
            // تحسين الحدة
            function enhanceSharpness(tensor) {
                const sharpnessKernel = tf.tensor2d([
                    [0, -1, 0],
                    [-1, 5, -1],
                    [0, -1, 0]
                ], [3, 3]);
                
                return tf.conv2d(tensor.expandDims(0), sharpnessKernel.expandDims(2).expandDims(3), 1, 'same').squeeze();
            }
            
            // تقليل الضوضاء
            function reduceNoise(tensor) {
                return tf.image.nonMaxSuppressionAsync(
                    tensor.expandDims(0),
                    [0.5],
                    10,
                    0.5
                ).then(() => tensor);
            }
            
            // تحسين تباين الباركود
            function enhanceBarcodeContrast(tensor) {
                // تطبيق thresholding لتحسين تباين الباركود
                const mean = tensor.mean();
                const threshold = mean;
                
                return tf.where(
                    tensor.greater(threshold),
                    tf.onesLike(tensor).mul(255),
                    tf.zerosLike(tensor)
                );
            }
            
            // تحسين الصورة بالطرق التقليدية
            function enhanceImageTraditional(imageData) {
                const ctx = document.createElement('canvas').getContext('2d');
                ctx.canvas.width = imageData.width;
                ctx.canvas.height = imageData.height;
                ctx.putImageData(imageData, 0, 0);
                
                const imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
                const data = imgData.data;
                
                // تحسين التباين والسطوع
                const contrast = 1.5;
                const brightness = 20;
                
                for (let i = 0; i < data.length; i += 4) {
                    // زيادة التباين
                    data[i] = ((data[i] / 255 - 0.5) * contrast + 0.5) * 255;
                    data[i+1] = ((data[i+1] / 255 - 0.5) * contrast + 0.5) * 255;
                    data[i+2] = ((data[i+2] / 255 - 0.5) * contrast + 0.5) * 255;
                    
                    // زيادة السطوع
                    data[i] = Math.min(255, Math.max(0, data[i] + brightness));
                    data[i+1] = Math.min(255, Math.max(0, data[i+1] + brightness));
                    data[i+2] = Math.min(255, Math.max(0, data[i+2] + brightness));
                }
                
                // تحسين الحدة
                enhanceSharpnessTraditional(imgData);
                
                return imgData;
            }
            
            // تحسين الحدة بالطرق التقليدية
            function enhanceSharpnessTraditional(imageData) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                
                // kernel لتحسين الحدة
                const kernel = [
                    [0, -1, 0],
                    [-1, 5, -1],
                    [0, -1, 0]
                ];
                
                // إنشاء نسخة من البيانات الأصلية
                const originalData = new Uint8ClampedArray(data);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        for (let c = 0; c < 3; c++) {
                            let sum = 0;
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const pixelIndex = ((y + ky) * width + (x + kx)) * 4 + c;
                                    sum += originalData[pixelIndex] * kernel[ky + 1][kx + 1];
                                }
                            }
                            const index = (y * width + x) * 4 + c;
                            data[index] = Math.min(255, Math.max(0, sum));
                        }
                    }
                }
            }
            
            // التقاط صورة من الكاميرا
            async function captureFrame() {
                const videoElement = document.querySelector('#interactive video');
                if (!videoElement || !videoElement.srcObject) return;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                
                // رسم الفيديو على canvas
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                
                // تحليل جودة الصورة
                analyzeImageQuality(canvas);
                
                // عرض معاينة الصورة
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                await showImageComparison(canvas, imageData);
            }
            
            // عرض مقارنة الصور
            async function showImageComparison(originalCanvas, originalImageData) {
                // الصورة الأصلية
                originalImage.src = originalCanvas.toDataURL('image/png');
                
                // تحسين الصورة
                processingMessage.textContent = 'جاري تحسين الصورة...';
                processingOverlay.style.display = 'flex';
                
                setTimeout(async () => {
                    let enhancedImageData;
                    
                    if (isAIEnabled && tfReady) {
                        enhancedImageData = await enhanceImageWithAI(originalImageData);
                    } else {
                        enhancedImageData = enhanceImageTraditional(originalImageData);
                    }
                    
                    // عرض الصورة المحسنة
                    const enhancedCanvas = document.createElement('canvas');
                    enhancedCanvas.width = enhancedImageData.width;
                    enhancedCanvas.height = enhancedImageData.height;
                    enhancedCanvas.getContext('2d').putImageData(enhancedImageData, 0, 0);
                    
                    enhancedImage.src = enhancedCanvas.toDataURL('image/png');
                    
                    processingOverlay.style.display = 'none';
                    imagePreview.style.display = 'block';
                    
                    // حفظ الصورة المحسنة
                    lastProcessedImage = {
                        original: originalCanvas.toDataURL('image/png'),
                        enhanced: enhancedCanvas.toDataURL('image/png'),
                        imageData: enhancedImageData
                    };
                    
                }, 100);
            }
            
            // معالجة الصورة المحسنة
            async function processEnhancedImage() {
                if (!lastProcessedImage) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = lastProcessedImage.imageData.width;
                canvas.height = lastProcessedImage.imageData.height;
                canvas.getContext('2d').putImageData(lastProcessedImage.imageData, 0, 0);
                
                // محاولة قراءة الباركود من الصورة المحسنة
                try {
                    const code = await readBarcodeFromImage(canvas);
                    if (code) {
                        processBarcode(code, 'ai_enhanced');
                    } else {
                        // محاولة قراءة الرقم باستخدام OCR
                        readTextFromEnhancedImage(canvas);
                    }
                } catch (error) {
                    console.error('خطأ في معالجة الصورة المحسنة:', error);
                }
            }
            
            // قراءة الباركود من صورة
            async function readBarcodeFromImage(canvas) {
                return new Promise((resolve) => {
                    const imageData = canvas.toDataURL('image/jpeg');
                    
                    Quagga.decodeSingle({
                        decoder: {
                            readers: [
                                'code_128_reader', 
                                'ean_reader', 
                                'ean_8_reader', 
                                'code_39_reader', 
                                'upc_reader',
                                'upc_e_reader'
                            ]
                        },
                        locate: true,
                        src: imageData,
                        numOfWorkers: 0
                    }, function(result) {
                        if (result && result.codeResult) {
                            resolve(result.codeResult.code);
                        } else {
                            resolve(null);
                        }
                    });
                });
            }
            
            // قراءة النص من الصورة المحسنة
            async function readTextFromEnhancedImage(canvas) {
                if (!ocrWorker) {
                    showStatusMessage('جارٍ تحميل نظام قراءة النص...', 'info');
                    return;
                }
                
                const result = await ocrWorker.recognize(canvas, 'eng', {
                    tessedit_char_whitelist: '0123456789',
                    tessedit_pageseg_mode: 7
                });
                
                const extractedNumbers = result.data.text.replace(/[^\d]/g, '').trim();
                if (extractedNumbers.length >= 8 && extractedNumbers.length <= 13) {
                    if (validateAndProcessBarcode(extractedNumbers)) {
                        processBarcode(extractedNumbers, 'ai_enhanced_ocr');
                    }
                }
            }
            
            // تهيئة Tesseract.js
            Tesseract.createWorker({
                logger: m => console.log(m),
            }).then(worker => {
                ocrWorker = worker;
                console.log('Tesseract worker جاهز');
            });
            
            // تهيئة سجل البحث
            renderSearchHistory();
            
            // تهيئة TensorFlow.js
            initializeTensorFlow();
            
            // تبديل التبويبات
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (scannerActive) {
                        stopScanner();
                    }
                });
            });
            
            // بدء الماسح الضوئي
            startScannerButton.addEventListener('click', startScanner);
            
            // التحكم في التكبير
            zoomInBtn.addEventListener('click', zoomIn);
            zoomOutBtn.addEventListener('click', zoomOut);
            zoomResetBtn.addEventListener('click', resetZoom);
            
            // إدارة النافذة المنبثقة
            closePopupBtn.addEventListener('click', closePopup);
            closeResultBtn.addEventListener('click', closePopup);
            printResultBtn.addEventListener('click', printResult);
            
            // التحكم في الذكاء الاصطناعي
            toggleAIBtn.addEventListener('click', () => {
                isAIEnabled = !isAIEnabled;
                toggleAIBtn.classList.toggle('active', isAIEnabled);
                toggleAIBtn.title = isAIEnabled ? 'تعطيل الذكاء الاصطناعي' : 'تفعيل الذكاء الاصطناعي';
                showStatusMessage(`الذكاء الاصطناعي ${isAIEnabled ? 'مفعل' : 'معطل'}`, 'info');
            });
            
            // التقاط صورة
            captureFrameBtn.addEventListener('click', captureFrame);
            
            // تبديل إعدادات الكاميرا
            toggleSettingsBtn.addEventListener('click', () => {
                cameraSettingsVisible = !cameraSettingsVisible;
                document.getElementById('camera-settings').style.display = 
                    cameraSettingsVisible ? 'block' : 'none';
            });
            
            // تبديل الكاميرا
            switchCameraBtn.addEventListener('click', switchCamera);
            
            // تحسين الصورة بالذكاء الاصطناعي
            aiEnhanceBtn.addEventListener('click', () => {
                if (scannerActive) {
                    captureFrame();
                } else {
                    showStatusMessage('يجب تشغيل الماسح الضوئي أولاً', 'error');
                }
            });
            
            // إغلاق معاينة الصورة
            closePreviewBtn.addEventListener('click', () => {
                imagePreview.style.display = 'none';
            });
            
            // استخدام الصورة المحسنة
            useEnhancedBtn.addEventListener('click', () => {
                imagePreview.style.display = 'none';
                processEnhancedImage();
            });
            
            // البحث بالباركود
            barcodeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const barcodeValue = barcodeInput.value.trim();
                if (!barcodeValue) {
                    showStatusMessage('الرجاء إدخال الباركود', 'error');
                    return;
                }
                searchProduct(barcodeValue, 'barcode');
            });
            
            // البحث بالاسم
            nameSearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const nameValue = nameInput.value.trim();
                if (!nameValue) {
                    showStatusMessage('الرجاء إدخال اسم المنتج', 'error');
                    return;
                }
                searchProduct(nameValue, 'name');
            });
            
            // بدء الماسح الضوئي
            async function startScanner() {
                try {
                    startScannerButton.disabled = true;
                    showStatusMessage('جاري تهيئة الماسح الضوئي...', 'success');
                    scannerContainer.style.display = 'block';
                    barcodeAttempts = 0;
                    currentMode = 'barcode';
                    updateModeIndicator();
                    
                    // طلب إذن الكاميرا
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: currentCamera,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 }
                        }
                    });
                    
                    currentStream = stream;
                    const videoElement = document.querySelector('#interactive video');
                    videoElement.srcObject = stream;
                    videoTrack = stream.getVideoTracks()[0];
                    
                    // إعدادات الكاميرا
                    setupCameraSettings();
                    
                    // تهيئة Quagga.js
                    await initializeQuagga();
                    
                    scannerActive = true;
                    showStatusMessage('الماسح الضوئي جاهز. قم بتوجيه الكاميرا نحو الباركود', 'success');
                    
                } catch (error) {
                    console.error('خطأ في تشغيل الماسح:', error);
                    showStatusMessage('خطأ في تشغيل الماسح الضوئي', 'error');
                    startScannerButton.disabled = false;
                    scannerContainer.style.display = 'none';
                }
            }
            
            // إعداد إعدادات الكاميرا
            function setupCameraSettings() {
                if (!videoTrack) return;
                
                const capabilities = videoTrack.getCapabilities();
                const settings = videoTrack.getSettings();
                
                if (capabilities.zoom) {
                    minZoom = capabilities.zoom.min || 1;
                    maxZoom = capabilities.zoom.max || 5;
                    zoomStep = capabilities.zoom.step || 0.5;
                    updateZoomButtons();
                }
                
                // تحديث قيم الإعدادات
                document.getElementById('sharpness-value').textContent = 
                    settings.sharpness || '0';
                document.getElementById('contrast-value').textContent = 
                    settings.contrast || '0';
                document.getElementById('brightness-value').textContent = 
                    settings.brightness || '0';
            }
            
            // تبديل الكاميرا
            async function switchCamera() {
                if (!scannerActive) return;
                
                currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
                
                try {
                    Quagga.stop();
                    
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: currentCamera,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    currentStream = stream;
                    const videoElement = document.querySelector('#interactive video');
                    videoElement.srcObject = stream;
                    videoTrack = stream.getVideoTracks()[0];
                    
                    setupCameraSettings();
                    await initializeQuagga();
                    
                    showStatusMessage(`تم تبديل الكاميرا إلى ${currentCamera === 'environment' ? 'الخلفية' : 'الأمامية'}`, 'info');
                    
                } catch (error) {
                    console.error('خطأ في تبديل الكاميرا:', error);
                    showStatusMessage('خطأ في تبديل الكاميرا', 'error');
                }
            }
            
            // تهيئة Quagga.js
            async function initializeQuagga() {
                return new Promise((resolve, reject) => {
                    Quagga.init({
                        inputStream: {
                            name: 'Live',
                            type: 'LiveStream',
                            target: document.querySelector('#interactive'),
                            constraints: {
                                facingMode: currentCamera,
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            },
                        },
                        locator: {
                            patchSize: 'medium',
                            halfSample: true
                        },
                        decoder: {
                            readers: [
                                'code_128_reader', 
                                'ean_reader', 
                                'ean_8_reader', 
                                'code_39_reader',
                                'upc_reader',
                                'upc_e_reader'
                            ],
                            multiple: false
                        },
                        locate: true,
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: 10
                    }, function(err) {
                        if (err) {
                            reject(err);
                            return;
                        }
                        Quagga.start();
                        resolve();
                    });
                    
                    Quagga.onDetected(function(data) {
                        if (isProcessing) return;
                        
                        const code = data.codeResult.code;
                        console.log('تم اكتشاف باركود:', code);
                        
                        if (validateAndProcessBarcode(code)) {
                            processBarcode(code, 'quagga');
                        }
                    });
                    
                    Quagga.onProcessed(function(data) {
                        if (data && data.codeResult && data.codeResult.code) {
                            barcodeAttempts++;
                            if (barcodeAttempts >= maxBarcodeAttempts && currentMode === 'barcode') {
                                showStatusMessage('جاري التحويل إلى وضع قراءة الرقم...', 'info');
                                setTimeout(() => {
                                    switchToOCRMode();
                                }, 1000);
                            }
                        }
                    });
                });
            }
            
            // باقي الدوال تبقى كما هي...
            // [يتم الحفاظ على الدوال الأخرى من الكود السابق مع تعديلات طفيفة]
            
            // التحقق من صحة الباركود
            function validateAndProcessBarcode(code) {
                if (!code) return false;
                
                const length = code.length;
                if (length < 8 || length > 13) {
                    return false;
                }
                
                if (!/^\d+$/.test(code)) {
                    return false;
                }
                
                if (length === 13 && !isValidEAN13Checksum(code)) {
                    return false;
                }
                
                if (length === 8 && !isValidEAN8Checksum(code)) {
                    return false;
                }
                
                lastReadValues.push(code);
                if (lastReadValues.length > 5) lastReadValues.shift();
                
                const lastValueCount = lastReadValues.filter(val => val === code).length;
                return lastValueCount >= 2;
            }
            
            function isValidEAN13Checksum(code) {
                try {
                    let sum = 0;
                    for (let i = 0; i < 12; i++) {
                        sum += (i % 2 === 0 ? 1 : 3) * parseInt(code[i]);
                    }
                    const checksum = (10 - (sum % 10)) % 10;
                    return checksum === parseInt(code[12]);
                } catch {
                    return false;
                }
            }
            
            function isValidEAN8Checksum(code) {
                try {
                    let sum = 0;
                    for (let i = 0; i < 7; i++) {
                        sum += (i % 2 === 0 ? 3 : 1) * parseInt(code[i]);
                    }
                    const checksum = (10 - (sum % 10)) % 10;
                    return checksum === parseInt(code[7]);
                } catch {
                    return false;
                }
            }
            
            // التحول إلى وضع OCR
            function switchToOCRMode() {
                if (currentMode === 'ocr') return;
                
                currentMode = 'ocr';
                updateModeIndicator();
                Quagga.stop();
                
                showStatusMessage('الآن في وضع قراءة الرقم. قم بتوجيه الكاميرا نحو الرقم تحت الباركود', 'info');
                
                startContinuousOCRScan();
            }
            
            // التحول إلى وضع الباركود
            function switchToBarcodeMode() {
                if (currentMode === 'barcode') return;
                
                currentMode = 'barcode';
                updateModeIndicator();
                Quagga.start();
                
                showStatusMessage('الآن في وضع قراءة الباركود. قم بتوجيه الكاميرا نحو الباركود', 'info');
            }
            
            // تحديث مؤشر الوضع
            function updateModeIndicator() {
                if (modeIndicator) {
                    modeIndicator.textContent = `وضع القراءة: ${currentMode === 'barcode' ? 'باركود' : 'رقم'}`;
                }
            }
            
            // معالجة الباركود
            function processBarcode(code, source) {
                if (isProcessing) return;
                isProcessing = true;
                
                console.log(`معالجة الباركود من ${source}:`, code);
                
                if (barcodeInput.value !== code) {
                    barcodeInput.value = code;
                }
                
                showStatusMessage(`تم اكتشاف ${source === 'ocr' ? 'رقم' : 'باركود'}: ${code}`, 'success');
                
                setTimeout(() => {
                    stopScanner();
                    searchProduct(code, 'barcode');
                    isProcessing = false;
                }, 500);
            }
            
            // إيقاف الماسح الضوئي
            function stopScanner() {
                if (scannerActive) {
                    if (currentMode === 'barcode') {
                        Quagga.stop();
                    }
                    scannerActive = false;
                    lastReadValues = [];
                    startScannerButton.disabled = false;
                    
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                    }
                    
                    scannerContainer.style.display = 'none';
                    showStatusMessage('', '');
                }
            }
            
            // البحث عن المنتج
            function searchProduct(searchValue, searchType) {
                showStatusMessage('جاري البحث...', 'success');
                
                fetch('test.txt')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فشل تحميل ملف البيانات');
                        }
                        return response.text();
                    })
                    .then(data => {
                        const lines = data.split('\n');
                        let foundProducts = [];
                        
                        for (let line of lines) {
                            const [productName, productPrice, barcode] = line.split('/').map(item => item.trim());
                            if (searchType === 'barcode' && barcode === searchValue) {
                                foundProducts.push({ productName, productPrice, barcode });
                                break;
                            } else if (searchType === 'name' && productName.toLowerCase().includes(searchValue.toLowerCase())) {
                                foundProducts.push({ productName, productPrice, barcode });
                            }
                        }
                        
                        if (foundProducts.length > 0) {
                            if (searchType === 'barcode') {
                                displayProductInfo(foundProducts[0]);
                                addToSearchHistory(foundProducts[0]);
                            } else {
                                displayNameSearchResults(foundProducts);
                            }
                        } else {
                            if (searchType === 'barcode') {
                                displayProductInfo(null);
                            } else {
                                displayNameSearchResults([]);
                            }
                        }
                        
                        showStatusMessage('', '');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showStatusMessage(error.message, 'error');
                    });
            }
            
            // عرض معلومات المنتج
            function displayProductInfo(product) {
                const productInfo = document.getElementById('product-info');
                
                if (product) {
                    productInfo.innerHTML = `
                        <div class="info-row product-name">
                            <span class="info-label">اسم المنتج:</span>
                            <span class="info-value">${product.productName}</span>
                        </div>
                        <div class="info-row product-price">
                            <span class="info-label">السعر:</span>
                            <span class="info-value">${product.productPrice} ₪</span>
                        </div>
                        <div class="info-row product-barcode">
                            <span class="info-label">الباركود:</span>
                            <span class="info-value">${product.barcode}</span>
                        </div>
                    `;
                } else {
                    productInfo.innerHTML = `
                        <div class="not-found">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>المنتج غير موجود في قاعدة البيانات</p>
                        </div>
                    `;
                }
                
                openPopup();
            }
            
            // عرض نتائج البحث بالاسم
            function displayNameSearchResults(products) {
                const resultsContainer = document.getElementById('name-search-results');
                
                if (products.length > 0) {
                    let html = '<div class="search-results-list">';
                    html += `<h3>تم العثور على ${products.length} نتيجة:</h3>`;
                    
                    products.forEach(product => {
                        html += `
                            <div class="product-result" data-barcode="${product.barcode}">
                                <h4>${product.productName}</h4>
                                <p>السعر: ${product.productPrice} ₪ | الباركود: ${product.barcode}</p>
                                <button class="btn btn-secondary view-product" style="margin-top: 5px;">عرض التفاصيل</button>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    resultsContainer.innerHTML = html;
                    
                    document.querySelectorAll('.view-product').forEach(button => {
                        button.addEventListener('click', function() {
                            const barcode = this.closest('.product-result').getAttribute('data-barcode');
                            const product = products.find(p => p.barcode === barcode);
                            displayProductInfo(product);
                            addToSearchHistory(product);
                        });
                    });
                } else {
                    resultsContainer.innerHTML = `
                        <div class="not-found">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>لا توجد منتجات مطابقة للبحث</p>
                        </div>
                    `;
                }
            }
            
            // إضافة إلى سجل البحث
            function addToSearchHistory(product) {
                if (!product) return;
                
                const existingIndex = searchHistoryData.findIndex(item => item.barcode === product.barcode);
                if (existingIndex !== -1) {
                    searchHistoryData.splice(existingIndex, 1);
                }
                
                searchHistoryData.unshift({
                    name: product.productName,
                    price: product.productPrice,
                    barcode: product.barcode,
                    date: new Date().toISOString()
                });
                
                if (searchHistoryData.length > 10) {
                    searchHistoryData.pop();
                }
                
                localStorage.setItem('searchHistory', JSON.stringify(searchHistoryData));
                renderSearchHistory();
            }
            
            // عرض سجل البحث
            function renderSearchHistory() {
                searchHistory.innerHTML = '';
                
                if (searchHistoryData.length === 0) {
                    searchHistory.innerHTML = '<li style="text-align: center; padding: 20px; color: #666;">لا توجد عمليات بحث سابقة</li>';
                    return;
                }
                
                searchHistoryData.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div class="history-item-info">
                            <div class="history-item-name">${item.name}</div>
                            <div class="history-item-details">
                                <span>${item.price} ₪</span>
                                <span>${formatDate(item.date)}</span>
                                <span>${item.barcode}</span>
                            </div>
                        </div>
                        <div class="history-item-actions">
                            <button class="action-btn view" title="عرض"><i class="fas fa-eye"></i></button>
                            <button class="action-btn delete" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    
                    li.querySelector('.view').addEventListener('click', () => {
                        searchProduct(item.barcode, 'barcode');
                    });
                    
                    li.querySelector('.delete').addEventListener('click', () => {
                        deleteSearchHistoryItem(item.barcode);
                    });
                    
                    searchHistory.appendChild(li);
                });
            }
            
            // حذف عنصر من سجل البحث
            function deleteSearchHistoryItem(barcode) {
                searchHistoryData = searchHistoryData.filter(item => item.barcode !== barcode);
                localStorage.setItem('searchHistory', JSON.stringify(searchHistoryData));
                renderSearchHistory();
            }
            
            // تنسيق التاريخ
            function formatDate(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString('ar-SA');
            }
            
            // عرض رسالة الحالة
            function showStatusMessage(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status-message';
                if (type) {
                    statusMessage.classList.add(type);
                }
            }
            
            // فتح النافذة المنبثقة
            function openPopup() {
                popup.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // إغلاق النافذة المنبثقة
            function closePopup() {
                popup.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            // طباعة النتيجة
            function printResult() {
                const printContent = `
                    <div style="font-family: 'Tajawal', sans-serif; text-align: right; direction: rtl; padding: 20px;">
                        <h2 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 10px; margin-bottom: 20px;">
                            تفاصيل المنتج
                        </h2>
                        ${document.getElementById('product-info').innerHTML}
                        <p style="margin-top: 30px; font-size: 12px; color: #666; text-align: left;">
                            تم الطباعة في ${new Date().toLocaleString('ar-SA')}
                        </p>
                    </div>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>طباعة تفاصيل المنتج</title>
                            <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                            <style>
                                body { margin: 0; padding: 0; }
                                @media print {
                                    @page { size: auto; margin: 10mm; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            }
            
            // التحكم في التكبير
            async function setZoom(zoomValue) {
                if (videoTrack) {
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ zoom: zoomValue }]
                        });
                        currentZoom = zoomValue;
                        updateZoomButtons();
                    } catch (err) {
                        console.error("فشل ضبط التكبير:", err);
                    }
                }
            }
            
            function zoomIn() {
                if (currentZoom < maxZoom) {
                    setZoom(Math.min(currentZoom + zoomStep, maxZoom));
                }
            }
            
            function zoomOut() {
                if (currentZoom > minZoom) {
                    setZoom(Math.max(currentZoom - zoomStep, minZoom));
                }
            }
            
            function resetZoom() {
                setZoom(1);
            }
            
            function updateZoomButtons() {
                zoomInBtn.disabled = currentZoom >= maxZoom;
                zoomOutBtn.disabled = currentZoom <= minZoom;
            }
            
            // تنظيف عند إغلاق الصفحة
            window.addEventListener('beforeunload', () => {
                stopScanner();
                if (ocrWorker) {
                    ocrWorker.terminate();
                }
            });
        });
    </script>
</body>
</html>